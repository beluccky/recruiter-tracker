<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: var(--surface);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        h1 { margin: 0; font-size: 1.25rem; }
        
        .tabs {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: var(--surface);
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #eff6ff;
        }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 80px; }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-danger { background: transparent; color: var(--danger); }
        .btn-danger:hover { background: #fef2f2; }
        .btn-sm { padding: 4px 8px; font-size: 0.85rem; }
        
        .candidate-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #f1f5f9;
            color: #475569;
        }
        .badge.today { background: #dcfce7; color: #166534; }
        .badge.tomorrow { background: #dbeafe; color: #1e40af; }
        .badge.past { background: #fee2e2; color: #991b1b; }
        
        .meta { font-size: 0.875rem; color: var(--text-secondary); display: flex; gap: 10px; align-items: center; }
        .actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--text);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-val { font-size: 1.2rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; z-index: 200;
            align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: white; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .code-block {
            background: #1e293b; color: #f8fafc; padding: 10px;
            border-radius: 4px; font-family: monospace; font-size: 0.8rem;
            overflow-x: auto; margin-top: 10px; white-space: pre;
        }

        @media (max-width: 600px) {
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<header>
    <h1>–¢—Ä–µ–∫–µ—Ä –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h1>
    <div style="display: flex; gap: 5px;">
        <button class="btn btn-outline btn-sm" onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('csvInput').click()">–ò–º–ø–æ—Ä—Ç</button>
        <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(this)">
        <button class="btn btn-outline btn-sm" onclick="openSettings()">‚öô</button>
    </div>
</header>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('add')">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" onclick="switchTab('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ <span id="activeCount"></span></button>
        <button class="tab" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
    </div>

    <!-- ADD TAB -->
    <div id="add" class="content-section active">
        <div class="card">
            <h2 style="margin-top:0; text-align:center;">–ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç</h2>
            <form id="addForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label>–§–ò–û *</label>
                    <input type="text" name="fio" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω">
                </div>
                <div class="form-group">
                    <label>–û–±—ä–µ–∫—Ç *</label>
                    <input type="text" name="object" required placeholder="–û—Ñ–∏—Å">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="text" name="phone" required placeholder="+7...">
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ *</label>
                        <input type="date" name="startDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                    <textarea name="note" placeholder="–î–µ—Ç–∞–ª–∏..."></textarea>
                </div>
                <button type="submit" class="btn" style="width:100%">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- ACTIVE TAB -->
    <div id="active" class="content-section">
        <div class="stats-bar" id="statsBar"></div>
        <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="searchActive" onkeyup="renderActive()" style="margin-bottom:15px;">
        <div id="activeList"></div>
    </div>

    <!-- ARCHIVE TAB -->
    <div id="archive" class="content-section">
        <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="searchArchive" onkeyup="renderArchive()" style="margin-bottom:15px;">
        <div id="archiveList"></div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheets</h3>
        <div class="form-group">
            <label>URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Apps Script</label>
            <input type="text" id="gsUrl" placeholder="https://script.google.com/..." onchange="saveSettings()">
        </div>
        <div style="font-size:0.85rem; color: #666;">
            <p>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</p>
            <ol style="padding-left:20px; margin:5px 0;">
                <li>–°–æ–∑–¥–∞–π—Ç–µ Google –¢–∞–±–ª–∏—Ü—É</li>
                <li>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è > Apps Script</li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ</li>
                <li>–ù–∞—á–∞—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ > –ù–æ–≤–æ–µ > –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</li>
                <li>–î–æ—Å—Ç—É–ø: <b>–í—Å–µ (Anyone)</b></li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π URL —Å—é–¥–∞</li>
            </ol>
        </div>
        <div class="code-block">
function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  sheet.clear();
  var headers = ["ID", "–§–ò–û", "–û–±—ä–µ–∫—Ç", "–¢–µ–ª–µ—Ñ–æ–Ω", "–î–∞—Ç–∞", "–ò–Ω—Ñ–æ", "–°—Ç–∞—Ç—É—Å", "–°–æ–∑–¥–∞–Ω"];
  sheet.appendRow(headers);
  data.forEach(function(i){
    sheet.appendRow([i.id, i.fio, i.object, i.phone, i.startDate, i.note, i.status, i.createdAt]);
  });
  return ContentService.createTextOutput("Success");
}
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn" onclick="document.getElementById('settingsModal').classList.remove('open')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

<script>
    let data = JSON.parse(localStorage.getItem('candidate_reminder_app_data') || '{"candidates":[]}');
    let candidates = data.candidates || [];
    let googleSheetUrl = data.googleSheetUrl || "";

    const activeListEl = document.getElementById('activeList');
    const archiveListEl = document.getElementById('archiveList');
    const statsBarEl = document.getElementById('statsBar');
    const activeCountEl = document.getElementById('activeCount');

    // INIT
    document.getElementById('gsUrl').value = googleSheetUrl;
    renderAll();

    function switchTab(tabId) {
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        const tabs = ['add', 'active', 'archive'];
        document.querySelectorAll('.tab')[tabs.indexOf(tabId)].classList.add('active');
        
        if(tabId === 'active') renderActive();
        if(tabId === 'archive') renderArchive();
    }

    function handleSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const newItem = {
            id: Date.now().toString(),
            fio: form.fio.value,
            object: form.object.value,
            phone: form.phone.value,
            startDate: form.startDate.value,
            note: form.note.value,
            status: 'active',
            createdAt: new Date().toISOString()
        };
        candidates.push(newItem);
        save();
        form.reset();
        showToast('–ö–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
        switchTab('active');
    }

    function save() {
        localStorage.setItem('candidate_reminder_app_data', JSON.stringify({ candidates, googleSheetUrl }));
        renderAll();
        syncToGoogle();
    }

    function saveSettings() {
        googleSheetUrl = document.getElementById('gsUrl').value.trim();
        save();
        showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    }
    
    function openSettings() {
        document.getElementById('settingsModal').classList.add('open');
    }

    function syncToGoogle() {
        if(!googleSheetUrl) return;
        // Debounce could be added here, but simple fetch is ok
        fetch(googleSheetUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(candidates)
        }).catch(err => console.log(err));
    }

    function updateStatus(id, status) {
        const c = candidates.find(x => x.id === id);
        if (c) {
            c.status = status;
            save();
            showToast(status === 'done' ? '–í –∞—Ä—Ö–∏–≤' : '–ê–∫—Ç–∏–≤–µ–Ω');
        }
    }

    function remove(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
            candidates = candidates.filter(x => x.id !== id);
            save();
            showToast('–£–¥–∞–ª–µ–Ω–æ');
        }
    }

    function edit(id) {
        const c = candidates.find(x => x.id === id);
        if(!c) return;
        const newFio = prompt('–§–ò–û:', c.fio);
        if(newFio === null) return;
        
        c.fio = newFio;
        c.object = prompt('–û–±—ä–µ–∫—Ç:', c.object) || c.object;
        c.phone = prompt('–¢–µ–ª–µ—Ñ–æ–Ω:', c.phone) || c.phone;
        c.startDate = prompt('–î–∞—Ç–∞ (YYYY-MM-DD):', c.startDate) || c.startDate;
        c.note = prompt('–ò–Ω—Ñ–æ:', c.note) || c.note;
        save();
        showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ');
    }

    function addToCalendar(id) {
        const c = candidates.find(x => x.id === id);
        if(!c) return;
        const text = encodeURIComponent(`–í—ã—Ö–æ–¥: ${c.fio} (${c.object})`);
        const details = encodeURIComponent(`–¢–µ–ª: ${c.phone}\n–ò–Ω—Ñ–æ: ${c.note}`);
        const dateStr = c.startDate.replace(/-/g, '');
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${details}&dates=${dateStr}/${dateStr}`;
        window.open(url, '_blank');
    }

    function shareToTG(id) {
        const c = candidates.find(x => x.id === id);
        if(!c) return;
        const text = encodeURIComponent(
            `üë§ *–ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç*\n` +
            `–§–ò–û: ${c.fio}\n` +
            `–û–±—ä–µ–∫—Ç: ${c.object}\n` +
            `–¢–µ–ª: ${c.phone}\n` +
            `üìÖ ${c.startDate}`
        );
        window.open(`https://t.me/share/url?url=&text=${text}`, '_blank');
    }

    function renderAll() {
        renderActive();
        renderArchive();
        updateStats();
    }

    function renderActive() {
        const term = (document.getElementById('searchActive')?.value || '').toLowerCase();
        const list = candidates.filter(c => c.status === 'active' && (c.fio.toLowerCase().includes(term) || c.object.toLowerCase().includes(term)));
        list.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
        activeListEl.innerHTML = list.length ? list.map(c => createCard(c)).join('') : '<div style="text-align:center;color:#888;padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    }

    function renderArchive() {
        const term = (document.getElementById('searchArchive')?.value || '').toLowerCase();
        const list = candidates.filter(c => c.status === 'done' && (c.fio.toLowerCase().includes(term) || c.object.toLowerCase().includes(term)));
        list.sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
        archiveListEl.innerHTML = list.length ? list.map(c => createCard(c)).join('') : '<div style="text-align:center;color:#888;padding:20px;">–ü—É—Å—Ç–æ</div>';
    }

    function createCard(c) {
        const isDone = c.status === 'done';
        const date = new Date(c.startDate);
        const today = new Date(); today.setHours(0,0,0,0); date.setHours(0,0,0,0);
        const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24)); 
        
        let badgeClass = 'badge'; let badgeText = diffDays + ' –¥–Ω.';
        if (diffDays === 0) { badgeClass += ' today'; badgeText = '–°–µ–≥–æ–¥–Ω—è'; }
        else if (diffDays === 1) { badgeClass += ' tomorrow'; badgeText = '–ó–∞–≤—Ç—Ä–∞'; }
        else if (diffDays < 0) { badgeClass += ' past'; badgeText = '–ü—Ä–æ—à–ª–æ'; }
        if(isDone) { badgeClass = 'badge'; badgeText = '–ê—Ä—Ö–∏–≤ ' + c.startDate; }

        return `
        <div class="card candidate-item">
            <div class="candidate-header">
                <div>
                    <div style="font-weight:bold;">${c.fio} ${!isDone ? `<span class="${badgeClass}">${badgeText}</span>` : ''}</div>
                    <div class="meta">${c.object} ‚Ä¢ ${c.phone}</div>
                </div>
            </div>
            ${c.note ? `<div style="font-size:0.9rem;color:#666;background:#f9f9f9;padding:5px;">${c.note}</div>` : ''}
            <div class="actions">
                ${!isDone ? `
                    <button class="btn btn-outline btn-sm" onclick="addToCalendar('${c.id}')">üìÖ</button>
                    <button class="btn btn-outline btn-sm" onclick="shareToTG('${c.id}')">‚úà TG</button>
                    <button class="btn btn-outline btn-sm" onclick="edit('${c.id}')">‚úé</button>
                    <button class="btn btn-sm" onclick="updateStatus('${c.id}', 'done')" style="background:var(--success)">‚úì</button>
                ` : `
                    <button class="btn btn-outline btn-sm" onclick="updateStatus('${c.id}', 'active')">‚Ü∫</button>
                `}
                <button class="btn btn-danger btn-sm" onclick="remove('${c.id}')" style="margin-left:auto">üóë</button>
            </div>
        </div>`;
    }

    function updateStats() {
        const active = candidates.filter(c => c.status === 'active');
        const today = new Date(); today.setHours(0,0,0,0);
        const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
        const countToday = active.filter(c => { const d=new Date(c.startDate); d.setHours(0,0,0,0); return d.getTime() === today.getTime() }).length;
        const countTomorrow = active.filter(c => { const d=new Date(c.startDate); d.setHours(0,0,0,0); return d.getTime() === tomorrow.getTime() }).length;
        
        activeCountEl.innerText = active.length ? `(${active.length})` : '';
        statsBarEl.innerHTML = `
            <div class="stat-box"><div class="stat-val">${active.length}</div><div class="stat-label">–ê–∫—Ç–∏–≤</div></div>
            <div class="stat-box"><div class="stat-val">${countToday}</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
            <div class="stat-box"><div class="stat-val">${countTomorrow}</div><div class="stat-label">–ó–∞–≤—Ç—Ä–∞</div></div>
            <div class="stat-box"><div class="stat-val">${candidates.filter(c => c.status === 'done').length}</div><div class="stat-label">–ê—Ä—Ö–∏–≤</div></div>
        `;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function exportCSV() {
        const headers = ["id","fio","object","phone","startDate","note","status","createdAt"];
        const rows = candidates.map(c => headers.map(h => JSON.stringify(c[h] || '')).join(','));
        const blob = new Blob([[headers.join(','), ...rows].join('\n')], {type: 'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'candidates.csv'; a.click();
    }

    function importCSV(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const lines = e.target.result.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const newCands = [];
                for(let i=1; i<lines.length; i++) {
                    if(!lines[i].trim()) continue;
                    const vals = lines[i].split(',').map(v => v.replace(/^"|"$/g, ''));
                    if(vals.length === headers.length) {
                        let obj = {}; headers.forEach((h, idx) => obj[h] = vals[idx]);
                        newCands.push(obj);
                    }
                }
                if(newCands.length && confirm(`–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ ${newCands.length} –∑–∞–ø–∏—Å–µ–π?`)) {
                    candidates = newCands; save(); showToast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
                }
            } catch(err) { alert('–û—à–∏–±–∫–∞'); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
